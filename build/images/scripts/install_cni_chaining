#!/usr/bin/env bash

# Copyright 2022 Antrea Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

source logging

# Find the cni conf file with lowest name
while true; do
  cni_conf=$(ls /host/etc/cni/net.d | head -n1)
  if [[ ! -z $cni_conf ]]; then
    break
  fi
  log_info "CNI conf file not found. Retrying after 2 secs"
  sleep 2s
done
cni_conf="/host/etc/cni/net.d/$cni_conf"

if grep -sq "azure" $cni_conf; then
  sed -i 's/"mode":"bridge",/"mode":"transparent",/g' $cni_conf
fi

cat $cni_conf | jq '.plugins[] | .type' | grep antrea > /dev/null 2>&1
if [[ $? != 0 ]]; then
  content=$(cat $cni_conf | jq '.plugins += [{"type": "antrea"}]')
  echo "$content" > $cni_conf
fi

# Install Antrea binary file
install -m 755 /usr/local/bin/antrea-cni /host/opt/cni/bin/antrea

id
# Load the OVS kernel module
modprobe openvswitch || (echo "Failed to load the OVS kernel module from the container, try running 'modprobe openvswitch' on your Nodes"; exit 1)
