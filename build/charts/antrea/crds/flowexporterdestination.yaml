apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: flowexporterdestinations.crd.antrea.io
  labels:
    app: antrea
spec:
  group: crd.antrea.io
  versions:
    - name: v1alpha1
      served: true
      storage: true
      additionalPrinterColumns:
      - name: Address:Port
        type: string
        description: Address of flow collector.
        jsonPath: .spec.address
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            spec:
              type: object
              required:
                - address
                - protocol
              properties:
                address:
                  type: string
                  description: >
                    The flow collector address including port as a string.

                    Example:
                    - flow-aggregator/flow-aggregator:14739
                    - 10.244.10.10:4739
                  pattern: ^.+:[0-9]+$
                protocol:
                  type: object
                  description: >
                    The protocol used to send flow details.

                    Exactly one must be defined and non-nil.
                  oneOf:
                  - required: [ipfix]
                  - required: [grpc]
                  properties:
                    ipfix:
                      type: object
                      description: Configuration for using IPFIX protocol.
                      required:
                      - transport
                      properties:
                        transport:
                          type: string
                          enum:
                          - tcp
                          - udp
                          - tls
                    grpc:
                      type: object
                      description: Configuration for using gRPC protocol.
                filter:
                  type: object
                  properties:
                    protocols:
                      type: array
                      description: >
                        Filter for only flows whose protocol which match this filter.
                        The default is accept all protocols if unset or nil.

                        Supported values are [tcp, udp, sctp].
                      items:
                        type: string
                        enum:
                        - tcp
                        - udp
                        - sctp
                activeFlowExportTimeoutSeconds:
                  type: integer
                  format: int32
                  description: >
                    Provide the active flow export timeout in seconds, which is the timeout after which a flow
                    record is sent to the collector for active flows. Thus, for flows with a continuous
                    stream of packets, a flow record will be exported to the collector once the elapsed
                    time since the last export event is equal to the value of this timeout.
                  minimum: 1
                  default: 5
                idleFlowExportTimeoutSeconds:
                  type: integer
                  format: int32
                  description: >
                    Provide the idle flow export timeout in seconds, which is the timeout after which a flow
                    record is sent to the collector for idle flows. A flow is considered idle if no
                    packet matching this flow has been observed since the last export event.
                  minimum: 1
                  default: 15
                tlsConfig:
                  type: object
                  required:
                  - caConfigMap
                  properties:
                    minTLSVersion:
                      type: string
                      description: >
                        minTLSVersion specifies which version of TLS the client should accept from the server.
                        This defaults to VersionTLS12 if unspecified.
                      enum:
                        - VersionTLS12
                        - VersionTLS13
                      default: VersionTLS12
                    serverName:
                      type: string
                      description: >
                        serverName is used to verify the hostname on the returned certificate. If specified
                        it will be included in the client's handshake (SNI) to support virtual hosting unless
                        it is an IP address. If this field is omitted, the hostname used for certificate 
                        verification will default to the provided server address (spec.address).
                      minLength: 1
                    caConfigMap:
                      type: object
                      description: >
                        Specify the location of the ConfigMap containing the CA certificate used to authenticate
                        the collector service. The ConfigMap must store the certificate under the key 'ca.crt'.
                        To ensure flow exporter will have access to this resource it must be granted the proper
                        RBAC permissions.
                      required:
                      - namespace
                      - name
                      properties:
                        namespace:
                          type: string
                          description: Namespace of the ConfigMap containing the CA certificate.
                          minLength: 1
                        name:
                          type: string
                          description: Name of the ConfigMap containing the CA certificate.
                          minLength: 1
                    clientSecret:
                      type: object
                      description: >
                        Specify the location of the Secret containing the client certificate and private
                        key for mTLS. The Secret must contain the keys 'tls.crt' and 'tls.key'.
                        If omitted, client authentication will be disabled. To ensure flow exporter will
                        have access to this resource it must be granted the proper RBAC permissions.
                      required:
                      - namespace
                      - name
                      properties:
                        namespace:
                          type: string
                          description: Namespace of the Secret containing the client certificate/key.
                          minLength: 1
                        name:
                          type: string
                          description: Name of the Secret containing the client certificate/key.
                          minLength: 1
  scope: Cluster
  names:
    plural: flowexporterdestinations
    singular: flowexporterdestination
    kind: FlowExporterDestination
    shortNames:
      - flowexporterdest
