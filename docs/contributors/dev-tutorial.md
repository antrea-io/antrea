# Development Tutorial

## Before you contribute

First, you need to fork the Antrea repository to your own organization or
account.

If you already have a good idea: you can propose it in an issue, explaining your
thoughts and seeing if other contributors have any suggestions before starting
to write code.

If you don't have a specific idea: you can browse the issues and look for
something that interests you. For beginners, especially pay attention to issues
labeled "good first issue."

## Install Antrea on kind

Below, we will explain how to set up an Antrea development environment on Linux
using Kind. First, you need to ensure that you have installed the following
dependencies: go, docker, kubectl, and kind.

Next, clone the Antrea code:

```bash
git clone git@github.com:$YOUR_GITHUB_USERNAME/antrea.git
```

You can now run the unit tests:

```bash
make test-unit
```

In theory, all unit tests should pass.

Next, try building the local Docker image:

```bash
make antrea-agent antrea-controller antrea-cni antctl-release
NO_PULL=1 make ubuntu
```

If the build is successful, you should see the newly built image in the output
of `docker images antrea/antrea-ubuntu`.

To quickly create a Kind cluster with two worker nodes and one control plane
node and run e2e tests, execute the following command:

```bash
ci/kind/test-e2e-kind.sh --setup-only
```

Please note that this command creates a Kind cluster with the default name
`kind`, so ensure that there is no existing cluster with the same name in your
environment. Despite the misleading `--setup-only` option name, it not only sets
up the Kind cluster but also runs the e2e tests on it.

In theory, all e2e tests should pass.

At this point, Antrea has been successfully installed. You can check the status
of Antrea Pods by running the command `kubectl -n kube-system get pods -l
app=antrea`. You should see output similar to this:

```text
NAME                                 READY   STATUS    RESTARTS   AGE
antrea-agent-8xg7p                   2/2     Running   0          17h
antrea-agent-dr9t7                   2/2     Running   0          17h
antrea-agent-k4q2p                   2/2     Running   0          17h
antrea-controller-867769649d-pnrgl   1/1     Running   0          17h
```

If you need to delete the Kind cluster, you can run `ci/kind/test-e2e-kind.sh
--cleanup-only`.

## Start coding

Now, let's assume that we want to implement the following requirement: We need
to add a `uid` field to the `spec` of the Antrea traceflow CRD. Additionally,
whenever we start a traceflow object, we want antrea-agent and antrea-controller
to log a message containing the `uid`.

Before writing any code, first create a new branch called `add-tf-uid`:

```bash
git checkout -b add-tf-uid
```

### Modify the CRD

The Antrea CRDs are stored in the `build/charts/antrea/crds` directory.

Add the definition of the `uid` field under
`openAPIV3Schema/properties/spec/properties` in
`build/charts/antrea/crds/traceflow.yaml`:

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: traceflows.crd.antrea.io
  labels:
    app: antrea
spec:
  group: crd.antrea.io
  versions:
    - name: v1alpha1
      # ...
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            spec:
              type: object
              properties:
                # ...
                # Add here!
                uid:
                  type: string
```

After making the changes, apply the modification using `kubectl apply -f
build/charts/antrea/crds/traceflow.yaml`.

Note: The actual yaml files used to deploy Antrea are automatically generated
from the files in the `build/charts/antrea` directory. Therefore, it is a good
idea to run the following command to update the autogenerated yaml files in
`build/yamls`:

```bash
make manifest
```

Additionally, we need to modify the struct definition in the program, which is
located in `pkg/apis/crd/<API_VERSION>/types.go`. Open
`pkg/apis/crd/v1alpha1/types.go` and modify the `TraceflowSpec` definition:

```go
TraceflowSpec struct {
    // ...
    UID string `json:"uid,omitempty"`
}
```

As this part of the code involves some autogenerated code, such as deepcopy,
you'll need to run `make codegen` after the modification.

### Modify the program logic

Next, we will modify the code in antrea-agent and antrea-controller.

The code for antrea-agent can be found in the `pkg/agent` directory, and the
code for antrea-controller is located in the `pkg/controller` directory.

Modify the `addTraceflow` function in
`pkg/agent/controller/traceflow/traceflow_controller.go`:

```go
func (c *Controller) addTraceflow(obj interface{}) {
    tf := obj.(*crdv1alpha1.Traceflow)
    klog.InfoS("Processing Traceflow ADD event", "uid", tf.Spec.UID)
    // ...
}
```

Likewise, modify the `addTraceflow` function in
`pkg/controller/traceflow/controller.go`.

After making the changes, rebuild the Docker image:

```bash
make antrea-agent antrea-controller antrea-cni antctl-release
NO_PULL=1 make ubuntu
```

The built Docker image will not be automatically loaded into the Kind cluster.
You need to run the following commands to load the Docker image into the Kind
cluster and force Antrea to use the new image:

```bash
kind load docker-image antrea/antrea-ubuntu:latest
kubectl -n kube-system rollout restart deployment/antrea-controller daemonset/antrea-agent
```

### Initial testing

Before moving on, run the unit tests and e2e tests related to the changes to
check for any errors:

```bash
go test -v ./pkg/agent/controller/traceflow ./pkg/controller/traceflow
ci/kind/test-e2e-kind.sh --run TestTraceflow --test-only --encap-mode encap
```

The `--encap-mode encap` option is used to run only the `encap` mode e2e tests.
Antrea also supports `noEncap` and `hybrid` modes.

Next, manually test whether the new feature works. First, create a new
Traceflow:

```bash
kubectl apply -f - <<EOF
apiVersion: crd.antrea.io/v1alpha1
kind: Traceflow
metadata:
  name: tf-test
spec:
  liveTraffic: true
  source:
    namespace: default
    pod: nginx1
  destination:
    namespace: default
    pod: nginx2
  uid: foobar
EOF
```

Then, check whether antrea-agent and antrea-controller have logged the
corresponding messages:

For antrea-agent:

```bash
ANT_AGENT=$(kubectl -n kube-system get pods -o wide | grep "agent.*worker " | cut -d ' ' -f 1)
kubectl -n kube-system logs $ANT_AGENT | grep "Processing Traceflow ADD event"
```

For antrea-controller:

```bash
ANT_CONTROLLER=$(kubectl -n kube-system get pods -o wide | grep "antrea-controller" | cut -d ' ' -f 1)
kubectl -n kube-system logs $ANT_CONTROLLER | grep "Processing Traceflow ADD event"
```

If everything is working correctly, when running the above commands, you should
see output similar to the following:

```text
I0727 08:05:39.259424       1 traceflow_controller.go:192] "Processing Traceflow ADD event" uid="foobar"
```

### Write unit tests and e2e tests

Since this modification is relatively simple, there is no need to add new unit
tests or e2e tests. However, if you plan to make significant changes, it's a
good idea to add relevant unit tests and e2e tests.

## Commit the code

Before committing the code, run the tests one last time locally to ensure there
are no issues:

```bash
make test-unit
ci/kind/test-e2e-kind.sh --test-only
```

If everything is fine, you can commit the changes:

```bash
git add .
git commit -s
```

The `-s` option will add a signature at the end of the commit message, which is
required by Antrea. Please write a meaningful commit message. Then push your
local commit to the remote GitHub repository:

```bash
git push --set-upstream origin add-tf-uid
```

Next, you can create a Pull Request using GitHub to request that your
`add-tf-uid` branch be merged into the `main` branch of the upstream repository.

## Address feedback

Usually, the PR won't be merged immediately. Others will review your code, and
you should make improvements based on the reviewer's comments. After making the
necessary changes, amend your commit:

```bash
git add .
git commit --amend
git push -f
```

## Success

If your PR status shows "Merged," you have successfully completed the Antrea
contribution process. Congratulations!
